{% extends "base.html" %}
{% block content %}

<h2>Dashboard</h2>

<div class="d-flex justify-content-between align-items-center mb-3">

    <!-- Table switch -->
    <form method="get" class="d-flex">
        <select class="form-select me-2" name="table" onchange="this.form.submit()">
            {% for t in tables_list %}
                <option value="{{ t }}" {% if t == table_name %}selected{% endif %}>
                    {{ t }}
                </option>
            {% endfor %}
        </select>
    </form>

    <!-- EXPORT FILTERED BUTTON (Option A) -->
    <form id="exportForm" method="POST"
          action="{{ url_for('export_excel_filtered_manual', table=table_name) }}">
        <input type="hidden" name="filtered_rows" id="filtered_rows">
        <button class="btn btn-success">Export Filtered</button>
    </form>

</div>


<!-- COLUMN-BASED SEARCH -->
<div class="d-flex mb-3">
    <select id="columnSelect" class="form-select w-auto me-2">
        {% for key in table_data[0].keys() %}
            <option value="{{ loop.index0 }}">{{ key }}</option>
        {% endfor %}
    </select>

    <input type="text" id="columnSearch" class="form-control w-50"
           placeholder="Search in selected column...">
</div>

{% if table_data %}
<table id="dynamicTable" class="table table-bordered table-hover">
    <thead class="table-dark">
        <tr>
            {% for key in table_data[0].keys() %}
                <th>{{ key }}</th>
            {% endfor %}
            <th>Actions</th>
        </tr>
    </thead>

    <tbody>

        <!-- Existing rows -->
        {% for row in table_data %}
        <tr>
            <form method="POST">
                <input type="hidden" name="row_id" value="{{ row['id'] }}">

                {% for key, value in row.items() %}
                    <td>
                        <input type="text" name="{{ key }}" value="{{ value }}"
                               class="form-control form-control-sm">
                    </td>
                {% endfor %}

                <td>
                    <button name="action" value="update"
                            class="btn btn-success btn-sm">Save</button>
                    <button name="action" value="delete"
                            class="btn btn-danger btn-sm"
                            onclick="return confirm('Delete this row?')">Delete</button>
                </td>
            </form>
        </tr>
        {% endfor %}

        <!-- Add new row -->
        <tr>
            <form method="POST">
                {% for key in table_data[0].keys() %}
                    <td>
                        <input type="text" name="{{ key }}"
                               class="form-control form-control-sm">
                    </td>
                {% endfor %}
                <td>
                    <button name="action" value="add"
                            class="btn btn-primary btn-sm">Add</button>
                </td>
            </form>
        </tr>

    </tbody>
</table>

{% else %}
<p>No data found.</p>
{% endif %}


<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<script>
$(document).ready(function() {

    // MANUAL column search (Option A)
    $("#columnSearch").on("keyup", function() {
        let colIndex = parseInt($("#columnSelect").val());
        let searchValue = this.value.toLowerCase();

        $("#dynamicTable tbody tr").each(function() {
            let cellInput = $(this).find("td").eq(colIndex).find("input");
            if (cellInput.length) {
                let cellVal = cellInput.val().toLowerCase();
                if (cellVal.includes(searchValue)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            }
        });
    });

    // EXPORT ONLY VISIBLE ROWS (Option A)
    $("#exportForm").on("submit", function() {
        let filtered = [];

        $("#dynamicTable tbody tr:visible").each(function() {
            let rowData = {};

            $(this).find("input").each(function() {
                rowData[$(this).attr("name")] = $(this).val();
            });

            // Only push rows that actually contain inputs (avoid header row)
            if (Object.keys(rowData).length > 0) {
                filtered.push(rowData);
            }
        });

        $("#filtered_rows").val(JSON.stringify(filtered));
    });

});
</script>

{% endblock %}

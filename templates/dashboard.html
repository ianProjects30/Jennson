{% extends "base.html" %}
{% block content %}
<div class="container-fluid py-4">
    
    <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-2">
        <h2 class="text-dark fw-bold m-0">
            <i class="bi bi-bar-chart-line-fill text-primary me-2"></i> Table Dashboard 
            <small class="text-muted fs-5">/ {{ table_name | title }}</small>
        </h2>
        <span class="badge bg-secondary-subtle text-secondary-emphasis py-2 px-3 shadow-sm">
            Rows Displayed: <span id="total-rows-count">{{ table_data|length if table_data else 0 }}</span>
        </span>
    </div>

    <div class="card bg-white border-0 shadow-lg mb-4">
        <div class="card-body py-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap">

                <div class="d-flex align-items-center mb-2 mb-md-0">
                    <label for="tableSelect" class="form-label me-3 mb-0 fw-bold text-muted">
                        <i class="bi bi-database me-1"></i> Data Source:
                    </label>
                    <form method="get" class="d-flex">
                        <select id="tableSelect" class="form-select form-select-lg border-primary border-2 w-auto" name="table" onchange="this.form.submit()">
                            {% for t in tables_list %}
                                <option value="{{ t }}" {% if t == table_name %}selected{% endif %}>
                                    {{ t | title }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>
                </div>

                <!-- EXPORT FORM: Uses GET method to send filter parameters for server-side processing -->
<form id="exportForm" method="POST"
      action="{{ url_for('export_excel_filtered_manual', table=table_name) }}">
    <input type="hidden" name="filter_col_index" id="filter_col_index">
    <input type="hidden" name="filter_search_value" id="filter_search_value">
    <button type="submit" class="btn btn-lg btn-success">Export Filtered Data</button>
</form>


            </div>
        </div>
    </div>
    
    {% if table_data or table_name %}
    <div class="card bg-white shadow-lg mb-4">
        <div class="card-body">
            <h5 class="card-title text-primary fw-bold mb-3">
                <i class="bi bi-sliders me-2"></i> Interaction Controls
            </h5>
            <div class="row align-items-center">
                
                <div class="col-md-8 mb-3 mb-md-0">
                    <div class="input-group input-group-lg">
                        <select id="columnSelect" class="form-select w-auto border-secondary">
                            <!-- DEFENSIVE CHECK: Prevent IndexError if table_data is empty but keys exist -->
                            {% if table_data %}
                                {% for key in table_data[0].keys() %}
                                    <option value="{{ loop.index0 }}">{{ key | title }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="0" disabled>No Columns</option>
                            {% endif %}
                        </select>
                        <input type="text" id="columnSearch" class="form-control"
                                 placeholder="Search in selected column (Type and press Enter or click away)...">
                        <span class="input-group-text bg-light text-secondary"><i class="bi bi-search"></i></span>
                    </div>
                </div>

                <div class="col-md-4 d-flex align-items-center justify-content-md-end">
                    <label for="rowsPerPage" class="form-label me-3 mb-0 fw-bold text-secondary-emphasis">Rows per page:</label>
                    <select id="rowsPerPage" class="form-select w-auto border-secondary">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="0">All</option>
                    </select>
                </div>
                
            </div>
        </div>
    </div>
    
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white py-3">
            <h5 class="mb-0"><i class="bi bi-table me-2"></i> Current Data: {{ table_name | title }}</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="dynamicTable" class="table table-striped table-hover mb-0">
                    <thead class="table-light"> 
                        <tr>
                            <!-- DEFENSIVE CHECK: Only loop through keys if data exists -->
                            {% if table_data %}
                                {% for key in table_data[0].keys() %}
                                    <th class="sortable-header text-primary" data-column-index="{{ loop.index0 }}" data-sort-order="asc">
                                        {{ key | title }}
                                        <span class="sort-icon text-secondary"><i class="bi bi-arrow-down-up"></i></span> 
                                    </th>
                                {% endfor %}
                                <th class="text-center text-primary">Actions</th>
                            {% else %}
                                <th colspan="2" class="text-center">No Columns Available</th>
                            {% endif %}
                        </tr>
                    </thead>

                    <tbody>
                        <!-- Data Rows -->
                        {% for row in table_data %}
                        <tr class="data-row">
                            <form method="POST">
                                <!-- Pass the primary key 'id' to the server for update/delete -->
                                <input type="hidden" name="row_id" value="{{ row['id'] }}"> 

                                {% for key, value in row.items() %}
                                    <td>
                                        <input type="text" name="{{ key }}" value="{{ value }}"
                                                class="form-control form-control-sm border-0 bg-transparent text-dark">
                                    </td>
                                {% endfor %}

                                <td class="text-center">
                                    <button name="action" value="update"
                                            class="btn btn-sm btn-outline-success me-1" title="Save Changes">
                                            <i class="bi bi-save"></i>
                                    </button>
                                    <button name="action" value="delete"
                                            class="btn btn-sm btn-outline-danger" title="Delete Row"
                                            onclick="return confirm('Are you sure you want to delete this row?')">
                                            <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </form>
                        </tr>
                        {% endfor %}

                        <!-- Add New Row -->
                        {% if table_data %}
                        <tr id="addRow" class="table-primary border-top border-primary border-2">
                            <form method="POST">
                                {% for key in table_data[0].keys() %}
                                    <td>
                                        <!-- Don't pre-populate the 'id' field -->
                                        {% if key == 'id' %}
                                            <input type="text" name="{{ key }}" class="form-control form-control-sm border-secondary" disabled placeholder="Auto-generated">
                                        {% else %}
                                            <input type="text" name="{{ key }}" class="form-control form-control-sm border-secondary">
                                        {% endif %}
                                    </td>
                                {% endfor %}
                                <td class="text-center">
                                    <button name="action" value="add"
                                            class="btn btn-primary btn-sm w-75 shadow-sm">
                                            <i class="bi bi-plus-circle me-1"></i> Add New
                                    </button>
                                </td>
                            </form>
                        </tr>
                        {% endif %}

                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <nav aria-label="Table Pagination" class="mt-4">
        <ul class="pagination justify-content-center shadow-sm" id="pagination-controls">
            </ul>
    </nav>

    {% else %}
    <div class="alert alert-warning shadow-sm mt-4" role="alert">
        <i class="bi bi-info-circle me-2"></i> No data found for the table: <strong>{{ table_name }}</strong>.
        Please add a row using the "Add New" button below.
    </div>
    {% endif %}

    <!-- Custom Styling -->
    <style>
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }
        .sortable-header:hover {
            color: #0056b3 !important;
        }
        .sort-icon {
            margin-left: 5px;
            font-size: 0.85em; 
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Global state variables for pagination/sorting
            let currentPage = 1;
            let rowsPerPage = parseInt($("#rowsPerPage").val());
            const tableBody = $("#dynamicTable tbody");
            let allDataRows = tableBody.find("tr.data-row"); 
            
            let sortColumn = 0; 
            let sortOrder = 'asc'; 

            // Initialize total row count for the badge (before filtering)
            $('#total-rows-count').text(allDataRows.length);

            // --- Core Display and Pagination Functions ---

            function displayRows(page, filteredRows) {
                rowsPerPage = parseInt($("#rowsPerPage").val());
                allDataRows.hide(); 

                if (rowsPerPage === 0) {
                    filteredRows.show();
                    $("#pagination-controls").empty();
                    return;
                }

                const startIndex = (page - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;
                filteredRows.slice(startIndex, endIndex).show();
            }

            function setupPagination(filteredRows) {
                rowsPerPage = parseInt($("#rowsPerPage").val());
                const totalRows = filteredRows.length;
                
                // Update the badge with the current number of filtered rows
                $('#total-rows-count').text(totalRows);

                if (rowsPerPage === 0 || totalRows <= rowsPerPage) {
                    $("#pagination-controls").empty();
                    return;
                }

                const totalPages = Math.ceil(totalRows / rowsPerPage);
                const paginationContainer = $("#pagination-controls");
                paginationContainer.empty();

                // Generate Previous button
                paginationContainer.append(`
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}" data-page="prev">
                        <a class="page-link" href="#" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                `);

                // Generate Page number buttons
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);

                if (currentPage - 2 < 1) {
                    endPage = Math.min(totalPages, 5);
                } else if (currentPage + 2 > totalPages) {
                    startPage = Math.max(1, totalPages - 4);
                }


                for (let i = startPage; i <= endPage; i++) {
                    paginationContainer.append(`
                        <li class="page-item ${i === currentPage ? 'active' : ''}" data-page="${i}">
                            <a class="page-link" href="#">${i}</a>
                        </li>
                    `);
                }

                // Generate Next button
                paginationContainer.append(`
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}" data-page="next">
                        <a class="page-link" href="#" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                `);

                // Attach click handlers to page links
                paginationContainer.find("li:not(.disabled)").off("click").on("click", function(e) {
                    e.preventDefault();
                    const pageAction = $(this).data('page');
                    let newPage = currentPage;

                    if (pageAction === 'prev' && currentPage > 1) {
                        newPage = currentPage - 1;
                    } else if (pageAction === 'next' && currentPage < totalPages) {
                        newPage = currentPage + 1;
                    } else if (typeof pageAction === 'number') {
                        newPage = pageAction;
                    }

                    if (newPage !== currentPage) {
                        currentPage = newPage;
                        renderTable(); 
                    }
                });
            }

            // --- Sorting Function ---
            function getCellValue(row, index) {
                // Gets the value from the input field inside the table cell
                return $(row).children('td').eq(index).find('input').val() || '';
            }

            function sortTable(columnIndex, order) {
                const rows = allDataRows.get(); 

                rows.sort(function(a, b) {
                    const valA = getCellValue(a, columnIndex).toLowerCase();
                    const valB = getCellValue(b, columnIndex).toLowerCase();
                    
                    let comparison = 0;
                    if (valA > valB) {
                        comparison = 1;
                    } else if (valA < valB) {
                        comparison = -1;
                    }

                    return order === 'desc' ? (comparison * -1) : comparison;
                });

                $.each(rows, function(index, row) {
                    // Prepend/Append rows to the table body (excluding the Add New row)
                    tableBody.append(row); 
                });
                tableBody.append($("#addRow")); // Ensure Add Row is always last

                allDataRows = tableBody.find("tr.data-row");

                // Update sort icons
                $('.sortable-header').find('.sort-icon').html('<i class="bi bi-arrow-down-up"></i>');
                const currentHeader = $(`[data-column-index=${columnIndex}]`);
                currentHeader.find('.sort-icon').html(
                    order === 'asc' ? '<i class="bi bi-sort-up"></i>' : '<i class="bi bi-sort-down"></i>'
                );

                currentPage = 1;
                renderTable();
            }

            // --- Main Render Function ---

            function renderTable() {
                let searchValue = $("#columnSearch").val().toLowerCase();
                let colIndex = parseInt($("#columnSelect").val());
                let filteredRows = $(); 

                // 1. Filter rows based on search
                allDataRows.each(function() {
                    let $row = $(this);
                    let cellInput = $row.find("td").eq(colIndex).find("input");
                    
                    if (cellInput.length) {
                        let cellVal = cellInput.val().toLowerCase();
                        if (cellVal.includes(searchValue)) {
                            filteredRows = filteredRows.add($row);
                        }
                    }
                });
                
                // 2. Update hidden fields for the export form (CRITICAL!)
                $("#filter_col_index").val($("#columnSelect").val());
                $("#filter_search_value").val($("#columnSearch").val());

                // Reset page if current page is now out of bounds
                const totalFilteredPages = rowsPerPage > 0 ? Math.ceil(filteredRows.length / rowsPerPage) : 1;
                if (currentPage > totalFilteredPages && totalFilteredPages > 0) {
                    currentPage = totalFilteredPages;
                } else if (currentPage === 0) {
                    currentPage = 1;
                }

                // 3. Display the current page of the filtered rows
                displayRows(currentPage, filteredRows);
                
                // 4. Setup the pagination controls
                setupPagination(filteredRows);
                
                // Ensure the Add New Row is always visible if it exists
                $("#addRow").show();
            }


            // --- Event Handlers ---

            // 1. Column Header Click Handler
            $("#dynamicTable thead").on("click", ".sortable-header", function() {
                const newColumn = parseInt($(this).data('column-index'));
                let newOrder = $(this).data('sort-order');

                if (newColumn === sortColumn) {
                    newOrder = (newOrder === 'asc' ? 'desc' : 'asc');
                } else {
                    newOrder = 'asc';
                }

                sortColumn = newColumn;
                sortOrder = newOrder;
                $(this).data('sort-order', newOrder);

                sortTable(sortColumn, sortOrder);
            });


            // 2. Initial Rendering (including default sort)
            // Only run if there is data to process
            if (allDataRows.length > 0) {
                renderTable();
            } else {
                 setupPagination([]);
            }


            // 3. Handle column search changes
            $("#columnSearch, #columnSelect").on("keyup change", function() {
                currentPage = 1;
                renderTable();
            });

            // 4. Handle rows per page selector change
            $("#rowsPerPage").on("change", function() {
                rowsPerPage = parseInt($(this).val());
                currentPage = 1;
                renderTable();
            });
        });
    </script>
{% endblock %}